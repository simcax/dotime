pipeline:
  migration:
    image: ubuntu:rolling
    commands:
      - export FLYWAY_VERSION=9.1.2
      - export DB_SSL_MODE=require
      - export DB_SSL=true
      - export DB_ROOT_CERT_PATH=/tmp/.postgresql/root.crt
      - export CDB_CLUSTER=pink-gopher-2382
      - echo $FLYWAY_VERSION
      - export DB_CONNECTION_STRING="postgresql://$${DB_USERNAME}:$${DB_PASS}@$${DB_HOST}:26257/defaultdb?sslmode=require&sslrootcert=$DB_ROOT_CERT_PATH&options=--cluster%3D$CDB_CLUSTER"
      - echo $${DB_USERNAME}
      - echo $DB_USERNAME
      - echo $${DB_HOST}
      - apt update
      - apt install -y curl wget
      - curl https://binaries.cockroachdb.com/cockroach-v22.1.6.linux-amd64.tgz | tar -xz && cp -i cockroach-v22.1.6.linux-amd64/cockroach /usr/local/bin/
      - curl --create-dirs -o /tmp/.postgresql/root.crt -O https://cockroachlabs.cloud/clusters/c7fd02d9-3cf3-48de-ba24-3b5852dccd19/cert
      - cockroach sql --url $DB_CONNECTION_STRING --execute "CREATE DATABASE $DB_NAME"
      - cockroach sql --url $DB_CONNECTION_STRING --execute "SHOW DATABASES"
      - wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/$FLYWAY_VERSION/flyway-commandline-$FLYWAY_VERSION-linux-x64.tar.gz | tar xvz && ln -s `pwd`/flyway-$FLYWAY_VERSION/flyway /usr/local/bin
      - cd database
      - flyway info
      - flyway migrate
      - flyway info
    secrets: [ DB_PASSWORD, DB_USERNAME, DB_NAME, DB_HOST ]
    